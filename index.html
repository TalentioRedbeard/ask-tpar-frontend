<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPAR Dev Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; line-height: 1.35; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; min-width: 320px; flex: 1; }
    label { display:block; font-size: 12px; color:#555; margin-top:10px; }
    input, textarea, button { width: 100%; box-sizing: border-box; padding: 10px; margin-top: 6px; border-radius: 10px; border: 1px solid #ccc; }
    textarea { min-height: 90px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    button { cursor: pointer; border: 0; background: #111; color: #fff; }
    button.secondary { background: #666; }
    button.danger { background: #b00020; }
    .muted { color: #666; font-size: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b0b0b; color:#eaeaea; padding: 12px; border-radius: 12px; overflow:auto; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#f2f2f2; font-size:12px; }
    .ok { background:#e7f8ed; }
    .bad { background:#fde7ea; }
  </style>
</head>
<body>
  <h2>TPAR Dev Console</h2>
  <p class="muted">
    This page signs in with Supabase Auth, automatically uses the current <span class="pill">access_token</span>,
    and calls your Edge Functions with <span class="pill">Authorization: Bearer &lt;token&gt;</span>.
  </p>

  <div class="row">
    <div class="card">
      <h3>Auth</h3>

      <div id="authStatus" class="pill bad">Signed out</div>

      <label>Email</label>
      <input id="email" type="email" placeholder="you@company.com"/>

      <label>Password</label>
      <input id="password" type="password" placeholder="Your password"/>

      <div style="margin-top:10px" class="row">
        <div style="flex:1">
          <button id="btnSignIn">Sign in</button>
        </div>
        <div style="flex:1">
          <button id="btnSignOut" class="secondary">Sign out</button>
        </div>
      </div>

      <label>Password reset (sets your password if you never had one)</label>
      <button id="btnForgot" class="secondary">Send password reset email</button>
      <div class="muted" style="margin-top:6px">
        After clicking the email link, you'll come back here. If Supabase sends you with a recovery token,
        this page will show the "Set new password" box automatically.
      </div>

      <div id="recoveryBox" style="display:none; margin-top: 12px">
        <label>Set new password</label>
        <input id="newPassword" type="password" placeholder="New password"/>
        <button id="btnSetPassword">Set password</button>
      </div>

      <div style="margin-top:10px">
        <button id="btnShowToken" class="secondary">Show current access token</button>
        <pre id="tokenOut" style="display:none; margin-top:10px"></pre>
      </div>

      <pre id="authOut" style="margin-top:10px"></pre>
    </div>

    <div class="card">
      <h3>Ask TPAR</h3>

      <label>Functions base URL</label>
      <input id="functionsBase" value="https://bwpoqsfrygyopwxmegax.functions.supabase.co"/>

      <label>Question</label>
      <input id="question" placeholder='e.g. "list techs"'/>

      <label>Context (optional JSON)</label>
      <textarea id="context" placeholder='{"date":"2026-01-10"}'></textarea>

      <label>Debug (admin only)</label>
      <input id="debug" placeholder="true or false (default false)"/>

      <button id="btnAsk">POST /ask-tpar</button>

      <pre id="askOut" style="margin-top:10px"></pre>
    </div>

    <div class="card">
      <h3>Dev Snapshot</h3>

      <label>Include docs (admin only)</label>
      <input id="includeDocs" placeholder="true or false (default false)"/>

      <button id="btnSnapshot">GET /tpar-dev-snapshot</button>

      <pre id="snapOut" style="margin-top:10px"></pre>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --------- CONFIG (safe to be public) ----------
    // Use your project URL + anon key (anon key is meant to be public client-side).
    const SUPABASE_URL = "https://bwpoqsfrygyopwxmegax.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3cG9xc2ZyeWd5b3B3eG1lZ2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOj";
    // ----------------------------------------------

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    function show(el, on) { el.style.display = on ? "" : "none"; }

    function setAuthStatus(session) {
      const pill = $("authStatus");
      if (session?.user?.email) {
        pill.textContent = "Signed in: " + session.user.email;
        pill.className = "pill ok";
      } else {
        pill.textContent = "Signed out";
        pill.className = "pill bad";
      }
    }

    async function currentSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;
      return data.session;
    }

    async function requireAccessToken() {
      const session = await currentSession();
      const token = session?.access_token;
      if (!token) throw new Error("Not signed in (no access_token).");
      return token;
    }

    async function renderSession() {
      const session = await currentSession();
      setAuthStatus(session);
      $("authOut").textContent = JSON.stringify({
        has_session: !!session,
        user_email: session?.user?.email ?? null,
        expires_at: session?.expires_at ?? null,
      }, null, 2);
    }

    // If a recovery / oauth link drops tokens into the URL, supabase-js will often pick it up
    // and fire an auth event. We'll listen and show the recovery UI when needed.
    supabase.auth.onAuthStateChange((event, session) => {
      // PASSWORD_RECOVERY is common for reset links.
      if (event === "PASSWORD_RECOVERY") show($("recoveryBox"), true);
      // Some projects may emit SIGNED_IN after recovery exchange.
      if (event === "SIGNED_IN") show($("recoveryBox"), false);
      renderSession().catch(() => {});
    });

    // Initial render
    renderSession().catch(err => { $("authOut").textContent = String(err); });

    $("btnSignIn").onclick = async () => {
      try {
        const email = $("email").value.trim();
        const password = $("password").value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        show($("recoveryBox"), false);
        await renderSession();
      } catch (e) {
        $("authOut").textContent = "Sign-in failed: " + (e?.message ?? String(e));
      }
    };

    $("btnSignOut").onclick = async () => {
      try {
        await supabase.auth.signOut();
        show($("recoveryBox"), false);
        await renderSession();
      } catch (e) {
        $("authOut").textContent = "Sign-out failed: " + (e?.message ?? String(e));
      }
    };

    $("btnForgot").onclick = async () => {
      try {
        const email = $("email").value.trim();
        if (!email) throw new Error("Enter your email first.");
        const redirectTo = window.location.origin + window.location.pathname;
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        $("authOut").textContent = "Password reset email sent. Check inbox/spam. Then click the link.";
      } catch (e) {
        $("authOut").textContent = "Reset failed: " + (e?.message ?? String(e));
      }
    };

    $("btnSetPassword").onclick = async () => {
      try {
        const newPassword = $("newPassword").value;
        if (!newPassword || newPassword.length < 6) throw new Error("Password must be at least 6 characters.");
        const { data, error } = await supabase.auth.updateUser({ password: newPassword });
        if (error) throw error;
        show($("recoveryBox"), false);
        $("authOut").textContent = "Password updated. Now you can sign in normally.";
        await renderSession();
      } catch (e) {
        $("authOut").textContent = "Set password failed: " + (e?.message ?? String(e));
      }
    };

    $("btnShowToken").onclick = async () => {
      try {
        const token = await requireAccessToken();
        $("tokenOut").textContent = token;
        show($("tokenOut"), true);
      } catch (e) {
        $("tokenOut").textContent = "No token: " + (e?.message ?? String(e));
        show($("tokenOut"), true);
      }
    };

    async function fetchJson(url, opts) {
      const res = await fetch(url, opts);
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      return { status: res.status, json, raw: text };
    }

    $("btnAsk").onclick = async () => {
      try {
        const base = $("functionsBase").value.trim().replace(/\/+$/, "");
        const url = base + "/ask-tpar";
        const question = $("question").value.trim();
        if (!question) throw new Error("Enter a question.");
        const debugRaw = $("debug").value.trim().toLowerCase();
        const debug = debugRaw === "true" || debugRaw === "1" || debugRaw === "yes";

        let context = null;
        const ctxTxt = $("context").value.trim();
        if (ctxTxt) {
          try { context = JSON.parse(ctxTxt); }
          catch { throw new Error("Context must be valid JSON (or empty)."); }
        }

        const token = await requireAccessToken();
        const payload = { question, context, debug };

        const result = await fetchJson(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });

        $("askOut").textContent = JSON.stringify(result, null, 2);
      } catch (e) {
        $("askOut").textContent = "Ask failed: " + (e?.message ?? String(e));
      }
    };

    $("btnSnapshot").onclick = async () => {
      try {
        const base = $("functionsBase").value.trim().replace(/\/+$/, "");
        const includeDocsRaw = $("includeDocs").value.trim().toLowerCase();
        const includeDocs = includeDocsRaw === "true" || includeDocsRaw === "1" || includeDocsRaw === "yes";
        const url = base + "/tpar-dev-snapshot" + (includeDocs ? "?include_docs=true" : "");

        const token = await requireAccessToken();
        const result = await fetchJson(url, {
          method: "GET",
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${token}`,
          },
        });

        $("snapOut").textContent = JSON.stringify(result, null, 2);
      } catch (e) {
        $("snapOut").textContent = "Snapshot failed: " + (e?.message ?? String(e));
      }
    };
  </script>
</body>
</html>
