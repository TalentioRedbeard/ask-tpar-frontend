<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPAR Dev Console (v4)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; line-height: 1.35; }
    .row { display:flex; gap:14px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; min-width: 320px; flex: 1; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
    label { display:block; font-size: 12px; color:#555; margin-top:10px; }
    input, textarea, button { width: 100%; box-sizing: border-box; padding: 10px; margin-top: 6px; border-radius: 12px; border: 1px solid #ccc; }
    textarea { min-height: 90px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    button { cursor: pointer; border: 0; background: #111; color: #fff; }
    button.secondary { background: #666; }
    .muted { color: #666; font-size: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b0b0b; color:#eaeaea; padding: 12px; border-radius: 14px; overflow:auto; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#f2f2f2; font-size:12px; }
    .ok { background:#e7f8ed; }
    .bad { background:#fde7ea; }
    code { background:#f2f2f2; padding: 1px 6px; border-radius: 6px; }
    .inline { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .inline input[type="checkbox"] { width:auto; margin:0; }
  </style>
</head>
<body>
  <h2>TPAR Dev Console <span class="pill">v4</span></h2>
  <div class="muted">This page is for development. Debug mode can include DB results (admin only).</div>

  <div style="margin-top:10px">
    <span class="pill bad" id="bootPill">Boot: not loaded</span>
    <span class="pill bad" id="authPill">Auth: not initialized</span>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h3>Config</h3>

      <label>Supabase URL</label>
      <input id="sbUrl" value="https://bwpoqsfrygyopwxmegax.supabase.co"/>

      <label>Supabase anon key</label>
      <input id="sbAnon" placeholder="paste anon key here"/>

      <label>Functions base URL</label>
      <input id="fnBase" value="https://bwpoqsfrygyopwxmegax.functions.supabase.co"/>

      <button id="btnInit" class="secondary" type="button">Initialize Supabase client</button>
      <pre id="bootOut" style="margin-top:10px"></pre>
    </div>

    <div class="card">
      <h3>Auth</h3>

      <label>Email</label>
      <input id="email" type="email" placeholder="you@company.com"/>

      <label>Password</label>
      <input id="password" type="password" placeholder="your password"/>

      <div style="margin-top:10px" class="row">
        <div style="flex:1"><button id="btnSignIn" type="button">Sign in</button></div>
        <div style="flex:1"><button id="btnSignOut" class="secondary" type="button">Sign out</button></div>
      </div>

      <div class="inline">
        <input id="debugMode" type="checkbox" />
        <label for="debugMode" style="margin:0">Debug mode (include DB result when allowed)</label>
      </div>

      <label>Password reset email</label>
      <button id="btnForgot" class="secondary" type="button">Send password reset email</button>

      <div id="recoveryBox" style="display:none; margin-top:12px">
        <label>Set new password (after clicking email link)</label>
        <input id="newPassword" type="password" placeholder="new password (min 6 chars)"/>
        <button id="btnSetPassword" type="button">Set password</button>
      </div>

      <div style="margin-top:10px">
        <button id="btnRefreshSession" class="secondary" type="button">Refresh session</button>
        <button id="btnShowToken" class="secondary" type="button" style="margin-top:10px">Show current access token</button>
        <pre id="tokenOut" style="display:none; margin-top:10px"></pre>
      </div>

      <pre id="authOut" style="margin-top:10px"></pre>
    </div>

    <div class="card">
      <h3>ask-tpar</h3>
      <label>Question</label>
      <input id="question" placeholder='e.g. "list techs"'/>

      <label>Context JSON (optional)</label>
      <textarea id="context" placeholder='{"anything":"you want"}'></textarea>

      <button id="btnAsk" type="button">POST /ask-tpar</button>

      <h4 style="margin-top:12px">Errors / Debug</h4>
      <pre id="askErr"></pre>

      <h4 style="margin-top:12px">Response</h4>
      <pre id="askOut"></pre>
    </div>

    <div class="card">
      <h3>tpar-dev-snapshot</h3>
      <label>mode</label>
      <input id="snapMode" placeholder="lite | full | hash (if supported)"/>

      <label>include_docs</label>
      <input id="includeDocs" placeholder="true or false"/>

      <button id="btnSnap" type="button">GET /tpar-dev-snapshot</button>

      <h4 style="margin-top:12px">Errors / Debug</h4>
      <pre id="snapErr"></pre>

      <h4 style="margin-top:12px">Response</h4>
      <pre id="snapOut"></pre>
    </div>
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const setPill = (id, ok, text) => {
        const el = $(id);
        if (!el) return;
        el.textContent = text;
        el.className = "pill " + (ok ? "ok" : "bad");
      };
      const safeSet = (el, text) => { if (el) el.textContent = text || ""; };

      setPill("bootPill", true, "Boot: JS loaded");

      window.addEventListener("error", (e) => {
        safeSet($("bootOut"), "JS Error: " + (e?.message || String(e)));
        setPill("bootPill", false, "Boot: failed");
      });

      function loadSupabaseUmd() {
        return new Promise((resolve, reject) => {
          function load(src) {
            return new Promise((res, rej) => {
              const s = document.createElement("script");
              s.src = src;
              s.async = true;
              s.onload = () => res(true);
              s.onerror = () => rej(new Error("Failed to load: " + src));
              document.head.appendChild(s);
            });
          }
          load("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2")
            .catch(() => load("https://unpkg.com/@supabase/supabase-js@2"))
            .then(() => {
              if (!window.supabase || !window.supabase.createClient) {
                throw new Error("Supabase UMD loaded but window.supabase.createClient not found");
              }
              resolve(true);
            })
            .catch(reject);
        });
      }

      let sb = null;

      async function renderAuth(session) {
        if (!sb) {
          setPill("authPill", false, "Auth: no client");
          safeSet($("authOut"), "Initialize Supabase client first.");
          return;
        }
        const signedIn = !!session?.user?.email;
        setPill("authPill", signedIn, signedIn ? ("Auth: " + session.user.email) : "Auth: signed out");
        safeSet($("authOut"), JSON.stringify({
          signed_in: signedIn,
          user_email: session?.user?.email ?? null,
          expires_at: session?.expires_at ?? null
        }, null, 2));
      }

      async function initClient() {
        try {
          safeSet($("bootOut"), "Loading supabase-jsâ€¦");
          await loadSupabaseUmd();

          const url = $("sbUrl").value.trim();
          const anon = $("sbAnon").value.trim();
          if (!url || !anon) throw new Error("Paste Supabase URL + anon key, then click Initialize.");

          sb = window.supabase.createClient(url, anon);

          sb.auth.onAuthStateChange((event, session) => {
            if (event === "PASSWORD_RECOVERY") $("recoveryBox").style.display = "";
            if (event === "SIGNED_IN") $("recoveryBox").style.display = "none";
            renderAuth(session).catch(() => {});
          });

          const { data, error } = await sb.auth.getSession();
          if (error) throw error;

          safeSet($("bootOut"), "Supabase client initialized.");
          await renderAuth(data?.session || null);
        } catch (e) {
          setPill("bootPill", false, "Boot: failed");
          safeSet($("bootOut"), "Boot failed: " + (e?.message || String(e)));
        }
      }

      async function requireToken() {
        if (!sb) throw new Error("Initialize Supabase client first.");
        const { data, error } = await sb.auth.getSession();
        if (error) throw error;
        const token = data?.session?.access_token;
        if (!token) throw new Error("Not signed in (no access_token).");
        return token;
      }

      async function fetchJson(url, opts) {
        const res = await fetch(url, opts);
        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch {}
        return { status: res.status, json, raw: text };
      }

      $("btnInit").onclick = initClient;

      $("btnSignIn").onclick = async () => {
        try {
          if (!sb) throw new Error("Initialize Supabase client first.");
          const email = $("email").value.trim();
          const password = $("password").value;
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error) throw error;
          const { data } = await sb.auth.getSession();
          await renderAuth(data?.session || null);
        } catch (e) {
          safeSet($("authOut"), "Sign-in failed: " + (e?.message || String(e)));
        }
      };

      $("btnSignOut").onclick = async () => {
        try {
          if (!sb) throw new Error("Initialize Supabase client first.");
          const { error } = await sb.auth.signOut();
          if (error) throw error;
          const { data } = await sb.auth.getSession();
          await renderAuth(data?.session || null);
        } catch (e) {
          safeSet($("authOut"), "Sign-out failed: " + (e?.message || String(e)));
        }
      };

      $("btnRefreshSession").onclick = async () => {
        try {
          if (!sb) throw new Error("Initialize Supabase client first.");
          const { data, error } = await sb.auth.getSession();
          if (error) throw error;
          await renderAuth(data?.session || null);
          safeSet($("tokenOut"), "");
          $("tokenOut").style.display = "none";
        } catch (e) {
          safeSet($("authOut"), "Refresh failed: " + (e?.message || String(e)));
        }
      };

      $("btnForgot").onclick = async () => {
        try {
          if (!sb) throw new Error("Initialize Supabase client first.");
          const email = $("email").value.trim();
          if (!email) throw new Error("Enter your email first.");
          const redirectTo = window.location.origin + window.location.pathname;
          const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
          if (error) throw error;
          safeSet($("authOut"), "Password reset email sent. Check inbox/spam. Click the link to return here.");
        } catch (e) {
          safeSet($("authOut"), "Reset failed: " + (e?.message || String(e)));
        }
      };

      $("btnSetPassword").onclick = async () => {
        try {
          if (!sb) throw new Error("Initialize Supabase client first.");
          const pw = $("newPassword").value;
          if (!pw || pw.length < 6) throw new Error("Password must be at least 6 characters.");
          const { error } = await sb.auth.updateUser({ password: pw });
          if (error) throw error;
          $("recoveryBox").style.display = "none";
          safeSet($("authOut"), "Password updated. You can sign in normally now.");
        } catch (e) {
          safeSet($("authOut"), "Set password failed: " + (e?.message || String(e)));
        }
      };

      $("btnShowToken").onclick = async () => {
        try {
          const token = await requireToken();
          $("tokenOut").style.display = "";
          $("tokenOut").textContent = token;
        } catch (e) {
          $("tokenOut").style.display = "";
          $("tokenOut").textContent = "No token: " + (e?.message || String(e));
        }
      };

      $("btnAsk").onclick = async () => {
        safeSet($("askErr"), "");
        safeSet($("askOut"), "");
        try {
          const base = $("fnBase").value.trim().replace(/\/+$/, "");
          const url = base + "/ask-tpar";
          const question = $("question").value.trim();
          if (!question) throw new Error("Enter a question.");

          let context = null;
          const ctx = $("context").value.trim();
          if (ctx) context = JSON.parse(ctx);

          const debug = $("debugMode").checked;
          const payload = {
            question,
            context,
            debug,
            include_db_result: debug
          };

          const token = await requireToken();
          const anon = $("sbAnon").value.trim();

          const result = await fetchJson(url, {
            method: "POST",
            headers: { "Content-Type": "application/json", "apikey": anon, "Authorization": "Bearer " + token },
            body: JSON.stringify(payload)
          });

          if (result.status >= 400) {
            safeSet($("askErr"), JSON.stringify(result, null, 2));
          }
          safeSet($("askOut"), JSON.stringify(result, null, 2));
        } catch (e) {
          safeSet($("askErr"), "Ask failed: " + (e?.message || String(e)));
        }
      };

      $("btnSnap").onclick = async () => {
        safeSet($("snapErr"), "");
        safeSet($("snapOut"), "");
        try {
          const base = $("fnBase").value.trim().replace(/\/+$/, "");
          const includeDocs = ($("includeDocs").value.trim().toLowerCase() === "true");
          const mode = ($("snapMode").value.trim() || "");
          const qs = new URLSearchParams();
          if (includeDocs) qs.set("include_docs", "true");
          if (mode) qs.set("mode", mode);

          const url = base + "/tpar-dev-snapshot" + (qs.toString() ? ("?" + qs.toString()) : "");

          const token = await requireToken();
          const anon = $("sbAnon").value.trim();

          const result = await fetchJson(url, {
            method: "GET",
            headers: { "apikey": anon, "Authorization": "Bearer " + token }
          });

          if (result.status >= 400) {
            safeSet($("snapErr"), JSON.stringify(result, null, 2));
          }
          safeSet($("snapOut"), JSON.stringify(result, null, 2));
        } catch (e) {
          safeSet($("snapErr"), "Snapshot failed: " + (e?.message || String(e)));
        }
      };

      safeSet($("bootOut"), "Paste anon key, then click Initialize. Debug checkbox affects ask-tpar only.");
    })();
  </script>
</body>
</html>
