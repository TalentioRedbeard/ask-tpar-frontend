<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ask-TPAR</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255, 255, 255, 0.06);
      --panel-strong: rgba(255, 255, 255, 0.10);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.68);
      --muted2: rgba(255, 255, 255, 0.55);
      --accent: #38bdf8;
      --ok: #34d399;
      --warn: #fbbf24;
      --err: #fb7185;
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(56, 189, 248, 0.22), transparent 55%),
        radial-gradient(900px 700px at 85% 25%, rgba(52, 211, 153, 0.14), transparent 50%),
        radial-gradient(700px 600px at 50% 90%, rgba(251, 113, 133, 0.08), transparent 55%),
        linear-gradient(180deg, #050816 0%, #0b1220 100%);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      object-fit: contain;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }

    .title-block .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .title-block .subtitle {
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 2px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      user-select: none;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #9ca3af;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.07);
    }

    .dot.error { background: var(--err); }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }

    .status-pill span {
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
    }

    main { margin-top: 14px; }

    .layout {
      display: grid;
      grid-template-columns: 1.45fr 0.95fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 14px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }

    .card-title {
      font-weight: 700;
      font-size: 13.5px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      letter-spacing: 0;
      text-transform: none;
      font-weight: 600;
    }

    .card-body { padding: 16px; }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      padding: 12px 12px;
      color: var(--text);
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      font-family: var(--sans);
      font-size: 14px;
    }

    textarea { min-height: 112px; resize: vertical; }

    textarea:focus, input:focus {
      border-color: rgba(56,189,248,0.65);
      box-shadow:
        0 0 0 3px rgba(56,189,248,0.18),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      appearance: none;
      border: 1px solid rgba(56,189,248,0.45);
      background: linear-gradient(180deg, rgba(56,189,248,0.23), rgba(56,189,248,0.10));
      color: rgba(255,255,255,0.92);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.05s ease, filter 0.15s ease, background 0.2s ease, border-color 0.2s ease;
      user-select: none;
    }

    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    button.secondary {
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      font-weight: 650;
    }
    button.danger {
      border-color: rgba(251,113,133,0.45);
      background: linear-gradient(180deg, rgba(251,113,133,0.20), rgba(251,113,133,0.08));
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    .output {
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      padding: 12px 12px;
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 190px;
    }

    .output.placeholder { color: rgba(255,255,255,0.55); }

    .debug-output {
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
      overflow: auto;
      max-height: 520px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      user-select: none;
    }

    .badge.ok { border-color: rgba(52,211,153,0.35); background: rgba(52,211,153,0.08); color: rgba(209,250,229,0.95); }
    .badge.err { border-color: rgba(251,113,133,0.35); background: rgba(251,113,133,0.09); color: rgba(255,228,230,0.96); }
    .badge.warn { border-color: rgba(251,191,36,0.35); background: rgba(251,191,36,0.10); color: rgba(255,247,237,0.96); }

    .footer-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.4;
    }

    .debug-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
    }

    .plumbing-strip {
      height: 10px;
      background: linear-gradient(90deg, rgba(56,189,248,0.45), rgba(52,211,153,0.35), rgba(251,113,133,0.25));
      border-top: 1px solid rgba(255,255,255,0.10);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header>
      <div class="logo-wrap">
        <img src="logo.png" alt="Company Logo" class="logo" onerror="this.style.display='none'" />
        <div class="title-block">
          <div class="title">Ask-TPAR</div>
          <div class="subtitle">Tulsa Plumbing &amp; Remodeling • Stack-aware job assistant</div>
        </div>
      </div>

      <div class="status-pill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Idle</span>
      </div>
    </header>

    <main>
      <div class="layout">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span>Question</span>
              <span class="pill">Live DB / functions context</span>
            </div>
          </div>
          <div class="card-body">
            <label>Your question</label>
            <textarea id="question" placeholder="Ask something like: 'Show me today's jobs', 'What happened with call linking yesterday?', 'Why is invoice.paid failing?'"></textarea>

            <label style="margin-top: 10px">Context (optional)</label>
            <textarea id="context" placeholder="Extra context: time window, job id, customer name, assumptions, etc."></textarea>

            <div class="button-row">
              <button id="askButton" type="button" disabled>Ask</button>
              <button id="clearButton" class="secondary" type="button">Clear</button>
            </div>

            <label style="margin-top: 10px; display: block">Answer</label>
            <div id="answerOutput" class="output placeholder">
              Your answer will appear here.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span>DEBUG</span>
                <span class="pill">Raw ask-tpar response</span>
              </div>
              <div class="footer-note">
                This panel shows the exact function response. Use it to copy/paste into ChatGPT when
                we’re debugging.
              </div>
            </div>
          </div>

          <div class="plumbing-strip" aria-hidden="true"></div>

          <div class="input-group" style="margin-top: 2px; padding: 16px">
            <label>Sign in (required)</label>
            <div class="row">
              <div>
                <input id="authEmail" type="text" placeholder="email (e.g. you@tulsapar.com)" />
              </div>
              <div>
                <input id="authPassword" type="password" placeholder="password" />
              </div>
            </div>

            <div class="button-row">
              <button id="loginButton" class="secondary" type="button"><span>Sign In</span></button>
              <button id="signupButton" class="secondary" type="button"><span>Sign Up</span></button>
              <button id="forgotButton" class="secondary" type="button"><span>Forgot Password</span></button>
              <button id="logoutButton" class="secondary" type="button" disabled><span>Sign Out</span></button>
            </div>

            <div class="debug-note" id="authStatus">Not signed in</div>

            <div class="debug-note">
              Debug – raw JSON (or whatever the function actually sent) from ask-tpar will appear here.
            </div>

            <div class="debug-output">
              <div class="badge" id="debugStatus">no response yet</div>
              <pre id="debugOutput">{}</pre>
            </div>

            <div class="footer-note">
              Tip: if you see <code>Invalid JSON from ask-tpar</code>, the <code>raw</code> field
              here will show the actual body the function returned.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- UMD build: avoids ESM import failures that make buttons “do nothing” -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== CONFIG (edit these before deploy) =====
    const BUILD_ID = "****BUILD_ID_CHANGE_EACH_DEPLOY****";
    const SUPABASE_URL = "https://bwpoqsfrygyopwxmegax.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3cG9xc2ZyeWd5b3B3eG1lZ2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzkyNTcsImV4cCI6MjA4MjM5OTI1N30.HMwTK2obYHnv96hOcB6XMSkPXJicWL4nhUS2c7wUb2Q";
    const ASK_TPAR_ENDPOINT = `${SUPABASE_URL}/functions/v1/ask-tpar`;
    // ============================================

    // Use the UMD build loaded via <script src=...> (no ESM import, avoids “dead buttons” failures)
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const questionEl = document.getElementById("question");
    const contextEl = document.getElementById("context");
    const askButton = document.getElementById("askButton");
    const clearButton = document.getElementById("clearButton");
    const answerOutputEl = document.getElementById("answerOutput");
    const debugOutputEl = document.getElementById("debugOutput");
    const debugStatusEl = document.getElementById("debugStatus");
    const statusDotEl = document.getElementById("statusDot");
    const statusTextEl = document.getElementById("statusText");

    const authEmailEl = document.getElementById("authEmail");
    const authPasswordEl = document.getElementById("authPassword");
    const loginButton = document.getElementById("loginButton");
    const signupButton = document.getElementById("signupButton");
    const forgotButton = document.getElementById("forgotButton");
    const logoutButton = document.getElementById("logoutButton");
    const authStatusEl = document.getElementById("authStatus");


    // ===== PROOF THE SCRIPT IS RUNNING (shows in UI + console) =====
    try { authStatusEl.textContent = `JS loaded (${BUILD_ID})`; } catch (_) {}
    console.log("Ask-TPAR frontend loaded", BUILD_ID);

    window.addEventListener("error", (e) => {
      const msg = e?.message || e?.type || "Unknown error";
      try { authStatusEl.textContent = `JS ERROR: ${msg}`; } catch (_) {}
      console.error("JS ERROR:", e);
    });

    window.addEventListener("unhandledrejection", (e) => {
      const msg = e?.reason?.message || String(e?.reason || e);
      try { authStatusEl.textContent = `PROMISE ERROR: ${msg}`; } catch (_) {}
      console.error("PROMISE ERROR:", e);
    });

    // Expose for debugging in DevTools: window.__tpar.supabase, window.__tpar.showToken()
    window.__tpar = { BUILD_ID, SUPABASE_URL, ASK_TPAR_ENDPOINT, supabase };
    window.__tpar.showToken = async () => {
      const { data } = await supabase.auth.getSession();
      return data.session?.access_token || null;
    };
    // =============================================================


    function setStatus(state, message) {
      if (state === "loading") {
        statusDotEl.classList.remove("error");
        statusDotEl.style.background = "#fbbf24";
        statusTextEl.textContent = message || "Working…";
      } else if (state === "ok") {
        statusDotEl.classList.remove("error");
        statusDotEl.style.background = "#34d399";
        statusTextEl.textContent = message || "OK";
      } else if (state === "error") {
        statusDotEl.classList.add("error");
        statusDotEl.style.background = "#fb7185";
        statusTextEl.textContent = message || "Error";
      } else {
        statusDotEl.classList.remove("error");
        statusDotEl.style.background = "#9ca3af";
        statusTextEl.textContent = message || "Idle";
      }
    }

    function setAuthUI(session) {
      const signedIn = Boolean(session && session.user);
      if (signedIn) {
        const email = session.user.email || "signed in";
        authStatusEl.textContent = `Signed in as ${email} • ${BUILD_ID}`;
        loginButton.disabled = true;
        logoutButton.disabled = false;
        askButton.disabled = false;
      } else {
        authStatusEl.textContent = `Not signed in • ${BUILD_ID}`;
        loginButton.disabled = false;
        logoutButton.disabled = true;
        askButton.disabled = true;
      }
    }

    async function refreshAuthUI() {
      const { data } = await supabase.auth.getSession();
      setAuthUI(data.session);
      return data.session;
    }

    async function requireAccessToken() {
      const { data } = await supabase.auth.getSession();
      const token = data.session?.access_token || null;
      if (!token) throw new Error("Not signed in. Click Sign In first.");
      return token;
    }

    loginButton.addEventListener("click", async () => {
      try {
        console.log("Sign In clicked");
        const email = (authEmailEl.value || "").trim();
        const password = authPasswordEl.value || "";
        if (!email || !password) {
          authStatusEl.textContent = "Enter email + password.";
          return;
        }
        loginButton.disabled = true;
        authStatusEl.textContent = "Signing in…";
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await refreshAuthUI();
        authStatusEl.textContent = `Signed in. (${BUILD_ID})`;
      } catch (e) {
        authStatusEl.textContent = `Sign-in failed: ${e?.message || String(e)}`;
      } finally {
        loginButton.disabled = false;
      }
    });

    signupButton.addEventListener("click", async () => {
      try {
        const email = (authEmailEl.value || "").trim();
        const password = authPasswordEl.value || "";
        if (!email || !password) {
          authStatusEl.textContent = "Enter email + password, then click Sign Up.";
          return;
        }
        signupButton.disabled = true;
        authStatusEl.textContent = "Signing up… (you may need to confirm via email)";
        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: { emailRedirectTo: window.location.href },
        });
        if (error) throw error;
        await refreshAuthUI();
        authStatusEl.textContent = "Sign-up OK. If email confirmation is enabled, check your inbox.";
      } catch (e) {
        authStatusEl.textContent = `Sign-up failed: ${e?.message || String(e)}`;
      } finally {
        signupButton.disabled = false;
      }
    });

    forgotButton.addEventListener("click", async () => {
      try {
        const email = (authEmailEl.value || "").trim();
        if (!email) {
          authStatusEl.textContent = "Enter your email, then click Forgot Password.";
          return;
        }
        forgotButton.disabled = true;
        authStatusEl.textContent = "Sending password reset email…";
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.href,
        });
        if (error) throw error;
        authStatusEl.textContent = "Password reset email sent. Open the link, then set a new password here.";
      } catch (e) {
        authStatusEl.textContent = `Reset failed: ${e?.message || String(e)}`;
      } finally {
        forgotButton.disabled = false;
      }
    });

    logoutButton.addEventListener("click", async () => {
      try {
        logoutButton.disabled = true;
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        await refreshAuthUI();
        authStatusEl.textContent = `Signed out. (${BUILD_ID})`;
      } catch (e) {
        authStatusEl.textContent = `Sign-out failed: ${e?.message || String(e)}`;
      } finally {
        logoutButton.disabled = false;
      }
    });

    // Keep UI synced if session changes in another tab/window.
    // Also handle PASSWORD_RECOVERY so you can set a password on this same page.
    supabase.auth.onAuthStateChange(async (event) => {
      await refreshAuthUI();

      if (event === "PASSWORD_RECOVERY") {
        const newPassword = prompt("Enter a new password:");
        if (!newPassword) return;
        const { error } = await supabase.auth.updateUser({ password: newPassword });
        if (error) {
          authStatusEl.textContent = `Password update failed: ${error.message}`;
        } else {
          authStatusEl.textContent = "Password updated. You can sign in now.";
        }
      }
    });

    async function callAskTpar(question, context) {
      const payload = { question, context };

      const res = await fetch(ASK_TPAR_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${await requireAccessToken()}`,
        },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let json;

      try {
        json = JSON.parse(text);
      } catch (err) {
        json = {
          ok: false,
          error: "Invalid JSON from ask-tpar",
          raw: text,
          status: res.status,
        };
      }

      return { status: res.status, json };
    }

    function renderDebug(status, json) {
      const ok = status >= 200 && status < 300;
      debugStatusEl.textContent = `HTTP ${status}`;
      debugStatusEl.classList.remove("ok", "err", "warn");
      debugStatusEl.classList.add(ok ? "ok" : "err");
      debugOutputEl.textContent = JSON.stringify(json, null, 2);
    }

    function renderAnswer(json) {
      if (json && typeof json.answer === "string") {
        answerOutputEl.classList.remove("placeholder");
        answerOutputEl.textContent = json.answer;
        return;
      }
      if (json && typeof json.response === "string") {
        answerOutputEl.classList.remove("placeholder");
        answerOutputEl.textContent = json.response;
        return;
      }
      answerOutputEl.classList.remove("placeholder");
      answerOutputEl.textContent = JSON.stringify(json, null, 2);
    }

    function clearAll() {
      questionEl.value = "";
      contextEl.value = "";
      answerOutputEl.classList.add("placeholder");
      answerOutputEl.textContent = "Your answer will appear here.";
      debugStatusEl.textContent = "no response yet";
      debugStatusEl.classList.remove("ok", "err", "warn");
      debugOutputEl.textContent = "{}";
      setStatus("idle", "Idle");
    }

    askButton.addEventListener("click", async () => {
      const question = (questionEl.value || "").trim();
      const context = (contextEl.value || "").trim();
      if (!question) {
        setStatus("error", "Enter a question first");
        answerOutputEl.classList.add("placeholder");
        answerOutputEl.textContent = "Enter a question above, then click Ask.";
        return;
      }

      askButton.disabled = true;
      clearButton.disabled = true;
      setStatus("loading", "Querying ask-tpar…");
      answerOutputEl.classList.add("placeholder");
      answerOutputEl.textContent = "Thinking through the live stack…";

      try {
        const { status, json } = await callAskTpar(question, context);
        renderDebug(status, json);
        renderAnswer(json);

        if (status >= 200 && status < 300 && json && json.ok) {
          setStatus("ok", "Response OK");
        } else {
          setStatus("error", "Function error");
        }
      } catch (e) {
        renderDebug(0, { ok: false, error: e?.message || String(e) });
        answerOutputEl.classList.remove("placeholder");
        answerOutputEl.textContent = `Error: ${e?.message || String(e)}`;
        setStatus("error", "Request failed");
      } finally {
        askButton.disabled = false;
        clearButton.disabled = false;
      }
    });

    clearButton.addEventListener("click", () => clearAll());

    // initial UI sync
    refreshAuthUI().catch((e) => {
      authStatusEl.textContent = `Init failed: ${e?.message || String(e)}`;
      console.error(e);
    });
    setStatus("idle", `Idle (${BUILD_ID})`);
  </script>
</body>
</html>

